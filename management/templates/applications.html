{% extends "masteremployee.html" %}

{% block content %}
<div class="container mt-4">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Create Application Section (Corrected) -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
        <h4>Create New Application</h4>
    </div>
    <div class="card-body p-4">
        <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate id="applicationForm">
            {% csrf_token %}
            <div class="row">
                <!-- Left Column -->
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="assignType"><strong>Assign Type</strong></label>
                        <select class="form-control" id="assignType" name="assign_type" required onchange="toggleSharingFields()">
                            <option value="own" selected>Own (100% Commission)</option>
                            <option value="sharing">Sharing (Split Commission)</option>
                        </select>
                    </div>

                    <!-- Sharing Details (Moved to the correct location) -->
                    <div id="sharingDiv" style="display:none; border-left: 3px solid #007bff; padding-left: 15px; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label for="otherEmployee"><strong>Select Employee to Share With</strong></label>
                            <select class="form-control" id="otherEmployee" name="other_employee">
                                <option value="">-- Select Employee --</option>
                                {% for emp in other_employees %}
                                    <option value="{{ emp.employee_id }}">{{ emp.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Please select an employee to share with.</div>
                        </div>
                        <div class="form-group">
                            <label><strong>Commission Share (%)</strong></label>
                            <div class="d-flex justify-content-between">
                                <div style="width: 48%;">
                                    <label for="creatorShare" class="small">Your Share</label>
                                    <input type="number" class="form-control" id="creatorShare" name="creator_share" placeholder="e.g., 60">
                                    <div class="invalid-feedback" id="shareValidationFeedback">Shares must total 100.</div>
                                </div>
                                <div style="width: 48%;">
                                    <label for="partnerShare" class="small">Partner's Share</label>
                                    <input type="number" class="form-control" id="partnerShare" name="partner_share" placeholder="e.g., 40">
                                </div>
                            </div>
                            <small class="form-text text-muted">Both shares must add up to 100.</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="applicationName"><strong>Application Name</strong></label>
                        <input type="text" class="form-control" id="applicationName" name="application_name" required>
                        <div class="invalid-feedback">Please provide an application name.</div>
                    </div>
                    <div class="form-group">
                        <label for="customerName"><strong>Customer Name</strong></label>
                        <input type="text" class="form-control" id="customerName" name="customer_name" required>
                        <div class="invalid-feedback">Please provide the customer's name.</div>
                    </div>
                    <div class="form-group">
                        <label for="customerMobile"><strong>Customer Mobile Number</strong></label>
                        <input type="text" class="form-control" id="customerMobile" name="customer_mobile_number" required>
                        <div class="invalid-feedback">Please provide the customer's mobile number.</div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="totalCommission"><strong>Total Commission Amount (₹)</strong></label>
                        <input type="number" step="0.01" class="form-control" id="totalCommission" name="total_commission" required>
                        <div class="invalid-feedback">Please enter the total commission.</div>
                    </div>
                    <div class="form-group">
                        <label for="expectedDays"><strong>Expected Days to Complete</strong></label>
                        <input type="number" class="form-control" id="expectedDays" name="expected_days" min="1" value="1" required>
                        <div class="invalid-feedback">Please enter the expected days.</div>
                    </div>
                    <div class="form-group">
                        <label for="description"><strong>Work Description</strong></label>
                        <textarea class="form-control" id="description" name="description" rows="5" required></textarea>
                        <div class="invalid-feedback">Please provide a work description.</div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-3">
                <button type="submit" class="btn btn-success btn-lg px-5">Create Application</button>
            </div>
        </form>
    </div>
</div>


  <!-- Your Assigned Applications Section -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-info text-white">
      <h4>Your Assigned Applications</h4>
    </div>
    <div class="card-body">
      {% if applications %}
      <div class="row">
        {% for app in applications %}
        <div class="col-md-6 mb-3">
          <div class="card h-100">
            <div class="card-header">
              <strong>{{ app.application_name }}</strong>
              <span class="badge float-right {% if app.approved %}badge-success{% else %}badge-warning{% endif %}">
                {{ app.approved|yesno:"Approved,Pending" }}
              </span>
            </div>
            <div class="card-body">
              <p class="mb-1"><strong>Customer:</strong> {{ app.customer_name }}</p>
              <p class="mb-1"><strong>Created:</strong> {{ app.date_created|date:"d M Y" }}</p>
              <p><strong>Total Commission:</strong> ₹{{ app.total_commission|floatformat:2 }}</p>
            </div>
            <div class="card-footer">
                <a href="{% url 'application-detail' app.id %}" class="btn btn-sm btn-primary">View Details & Chat</a>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
        <p>You have not been assigned to any applications yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- Monthly Commissions Section -->
  <div class="card shadow-sm">
      <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
          <h4>Monthly Commissions</h4>
          <form method="get" class="form-inline">
              <label for="monthSelect" class="mr-2 mb-0 text-white">Month:</label>
              <select name="month" id="monthSelect" class="form-control form-control-sm mr-3" onchange="this.form.submit()">
                  {% for m in months %}<option value="{{ m.value }}" {% if m.value == selected_month %}selected{% endif %}>{{ m.display }}</option>{% endfor %}
              </select>
              <label for="yearSelect" class="mr-2 mb-0 text-white">Year:</label>
              <select name="year" id="yearSelect" class="form-control form-control-sm" onchange="this.form.submit()">
                  {% for y in years %}<option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>{% endfor %}
              </select>
          </form>
      </div>
      <div class="card-body">
          {% if approved_assignments %}
          <ul class="list-group mb-3">
              {% for assignment in approved_assignments %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                      {{ assignment.application.application_name }}
                      <small class="text-muted">({{ assignment.application.date_created|date:"d M Y" }})</small>
                  </div>
                  <span class="badge badge-primary badge-pill">₹{{ assignment.commission_share|floatformat:2 }}</span>
              </li>
              {% endfor %}
          </ul>
          <h5 class="text-right">Total for {{ selected_month_display }} {{ selected_year }}: <strong>₹{{ total_commission|floatformat:2 }}</strong></h5>
          {% else %}
            <p>No approved commissions found for {{ selected_month_display }} {{ selected_year }}.</p>
          {% endif %}
      </div>
  </div>
</div>

<script>
    // This function shows or hides the sharing section and updates 'required' attributes.
    function toggleSharingFields() {
        const assignType = document.getElementById('assignType').value;
        const sharingDiv = document.getElementById('sharingDiv');
        const otherEmployee = document.getElementById('otherEmployee');
        const creatorShare = document.getElementById('creatorShare');
        const partnerShare = document.getElementById('partnerShare');

        if (assignType === 'sharing') {
            sharingDiv.style.display = 'block';
            otherEmployee.required = true;
            creatorShare.required = true;
            partnerShare.required = true;
        } else {
            sharingDiv.style.display = 'none';
            otherEmployee.required = false;
            creatorShare.required = false;
            partnerShare.required = false;
        }
    }

    // This is the Bootstrap 5 validation script.
    // It prevents form submission if fields are invalid and adds visual feedback.
    (function () {
      'use strict'

      var form = document.getElementById('applicationForm');

      form.addEventListener('submit', function (event) {
        let isSharing = document.getElementById('assignType').value === 'sharing';
        let customValidationFailed = false;

        // Custom validation for commission shares.
        if (isSharing) {
            const creatorShareInput = document.getElementById('creatorShare');
            const partnerShareInput = document.getElementById('partnerShare');
            const shareFeedback = document.getElementById('shareValidationFeedback');
            
            const creatorVal = parseFloat(creatorShareInput.value) || 0;
            const partnerVal = parseFloat(partnerShareInput.value) || 0;

            if (creatorVal + partnerVal !== 100) {
                // By making the inputs invalid, Bootstrap's styling will catch them.
                creatorShareInput.setCustomValidity("Shares must add up to 100.");
                partnerShareInput.setCustomValidity("Shares must add up to 100.");
                customValidationFailed = true;
            } else {
                // Clear the custom error so they can be validated normally.
                creatorShareInput.setCustomValidity("");
                partnerShareInput.setCustomValidity("");
            }
        }

        // Check both standard HTML5 validation and our custom share validation.
        if (!form.checkValidity() || customValidationFailed) {
          event.preventDefault();
          event.stopPropagation();
        }

        form.classList.add('was-validated');
      }, false);
      
      // Ensure the form's initial state is correct on page load.
      toggleSharingFields();
    })();
</script>
{% endblock %}
