{% extends "masteremployee.html" %}

{% block content %}
<div class="container mt-4">
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Create Application Section (Two-Step Form) -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4>Create New Application</h4>
        </div>
        <div class="card-body p-3">
            <form method="post" class="needs-validation" novalidate id="applicationForm">
                {% csrf_token %}

                <!-- Step 1: Service Type Selection -->
                <div class="form-group">
                    <label for="serviceType"><strong>Step 1: Select a Service Type</strong></label>
                    <select class="form-control" id="serviceType" name="service_type" required onchange="showDetailsRow()">
                        <option value="" disabled selected>-- Select a service to begin --</option>
                        {% for st in service_types %}
                            <option value="{{ st.id }}">{{ st.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">Please select a service type.</div>
                </div>

                <!-- Step 2: Details Row (hidden until Step 1 is complete) -->
                <div class="form-row align-items-end" id="detailsRow" style="display:none;">
                    
                    <div class="col-md-2">
                        <label for="assignType"><strong>Assign Type</strong></label>
                        <select class="form-control" id="assignType" name="assign_type" onchange="toggleSharingFields()">
                            <option value="own" selected>Own</option>
                            <option value="sharing">Sharing</option>
                        </select>
                    </div>

                    <div class="col-md-2" id="sharingDiv" style="display:none;">
                        <label for="otherEmployee"><strong>Share With</strong></label>
                        <select class="form-control" id="otherEmployee" name="other_employee">
                            <option value="">Select Employee...</option>
                            {% for emp in other_employees %}
                                <option value="{{ emp.employee_id }}">{{ emp.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="customerName"><strong>Customer Name</strong></label>
                        <input type="text" class="form-control" id="customerName" name="customer_name" required>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="customerMobile"><strong>Mobile Number</strong></label>
                        <input type="text" class="form-control" id="customerMobile" name="customer_mobile_number" required>
                    </div>

                    <div class="col-md-2" id="totalCommissionGroup">
                        <label for="totalCommission"><strong>Total Commission (₹)</strong></label>
                        <input type="number" step="0.01" class="form-control" id="totalCommission" name="total_commission" required>
                    </div>

                    <div class="col-md-2">
                        <label for="expectedDate"><strong>Completion Date</strong></label>
                        <input type="date" class="form-control" id="expectedDate" name="expected_date_of_completion">
                    </div>

                    <div class="col-auto">
                        <button type="submit" class="btn btn-success">Create</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Your Assigned Applications Section -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-info text-white"><h4>Your Assigned Applications</h4></div>
        <div class="card-body">
            {% if applications %}
            <div class="row">
                {% for app in applications %}
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header">
                            <strong>{{ app.service_type.name }}</strong>
                            <span class="badge float-right {% if app.approved %}badge-success{% else %}badge-warning{% endif %}">
                                {{ app.approved|yesno:"Approved,Pending" }}
                            </span>
                        </div>
                        <div class="card-body">
                            <p class="mb-1"><strong>Customer:</strong> {{ app.customer_name }}</p>
                            <p class="mb-1"><strong>Created:</strong> {{ app.date_created|date:"d M Y" }}</p>
                            <p><strong>Total Commission:</strong> ₹{{ app.total_commission|floatformat:2 }}</p>
                        </div>
                        <div class="card-footer">
                            <a href="{% url 'application-detail' app.id %}" class="btn btn-sm btn-primary">View Details & Chat</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
                <p>You have not been assigned to any applications yet.</p>
            {% endif %}
        </div>
    </div>

    <!-- Monthly Commissions Section -->
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h4>Monthly Commissions</h4>
            <form method="get" class="form-inline">
                <label for="monthSelect" class="mr-2 mb-0 text-white">Month:</label>
                <select name="month" id="monthSelect" class="form-control form-control-sm mr-3" onchange="this.form.submit()">
                    {% for m in months %}<option value="{{ m.value }}" {% if m.value == selected_month %}selected{% endif %}>{{ m.display }}</option>{% endfor %}
                </select>
                <label for="yearSelect" class="mr-2 mb-0 text-white">Year:</label>
                <select name="year" id="yearSelect" class="form-control form-control-sm" onchange="this.form.submit()">
                    {% for y in years %}<option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>{% endfor %}
                </select>
            </form>
        </div>
        <div class="card-body">
            {% if approved_assignments %}
            <ul class="list-group mb-3">
                {% for assignment in approved_assignments %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        {{ assignment.application.service_type.name }}
                        <small class="text-muted">({{ assignment.application.date_created|date:"d M Y" }})</small>
                    </div>
                    <span class="badge badge-primary badge-pill">₹{{ assignment.commission_amount|floatformat:2 }}</span>
                </li>
                {% endfor %}
            </ul>
            <h5 class="text-right">Total for {{ selected_month_display }} {{ selected_year }}: <strong>₹{{ total_commission|floatformat:2 }}</strong></h5>
            {% else %}
                <p>No approved commissions found for {{ selected_month_display }} {{ selected_year }}.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function showDetailsRow() {
        const serviceSelect = document.getElementById('serviceType');
        const detailsRow = document.getElementById('detailsRow');
        
        if (serviceSelect.value) {
            detailsRow.style.display = 'flex';
        } else {
            detailsRow.style.display = 'none';
        }
        
        document.getElementById('assignType').value = 'own';
        toggleSharingFields();
    }

    function toggleSharingFields() {
        const assignType = document.getElementById('assignType').value;
        const sharingDiv = document.getElementById('sharingDiv');
        const otherEmployeeSelect = document.getElementById('otherEmployee');

        if (assignType === 'sharing') {
            sharingDiv.style.display = 'block';
            otherEmployeeSelect.required = true;
        } else { // 'own'
            sharingDiv.style.display = 'none';
            otherEmployeeSelect.required = false;
        }
    }

    // Bootstrap validation script
    (function () {
        'use strict'
        var form = document.getElementById('applicationForm');
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
        
        showDetailsRow();
    })();
</script>
{% endblock %}
