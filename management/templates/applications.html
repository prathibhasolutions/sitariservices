{% extends "masteremployee.html" %}

{% block content %}
<div class="container mt-4">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    {% endfor %}
  {% endif %}

   <!-- Create Application Section -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4>Create New Application</h4>
        </div>
        <div class="card-body p-4">
            <form method="post" class="needs-validation" novalidate id="applicationForm">
                {% csrf_token %}
                <div class="row">
                    <!-- Left Column -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="assignType"><strong>Assign Type</strong></label>
                            <select class="form-control" id="assignType" name="assign_type" required onchange="toggleSharingFields()">
                                <option value="own" selected>Own (Full Commission)</option>
                                <option value="sharing">Sharing (Split Commission)</option>
                            </select>
                        </div>

                        <!-- Sharing Details -->
                        <div id="sharingDiv" style="display:none; border-left: 3px solid #007bff; padding-left: 15px; margin-bottom: 1rem;">
                            <div class="form-group">
                                <label for="otherEmployee"><strong>Select Employee to Share With</strong></label>
                                <select class="form-control" id="otherEmployee" name="other_employee">
                                    <option value="">-- Select Employee --</option>
                                    {% for emp in other_employees %}
                                        <option value="{{ emp.employee_id }}">{{ emp.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">Please select an employee to share with.</div>
                            </div>
                            <div class="form-group">
                                <label><strong>Commission Share Amount (₹)</strong></label>
                                <div class="d-flex justify-content-between">
                                    <div style="width: 48%;">
                                        <label for="creatorShareAmount" class="small">Your Amount</label>
                                        <input type="number" step="0.01" class="form-control" id="creatorShareAmount" name="creator_share_amount" placeholder="e.g., 600">
                                    </div>
                                    <div style="width: 48%;">
                                        <label for="partnerShareAmount" class="small">Partner's Amount</label>
                                        <input type="number" step="0.01" class="form-control" id="partnerShareAmount" name="partner_share_amount" placeholder="e.g., 400">
                                    </div>
                                </div>
                                <small class="form-text text-muted">The total commission will be calculated from these amounts.</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="applicationName"><strong>Service Type</strong></label>
                            <input type="text" class="form-control" id="applicationName" name="application_name" required>
                            <div class="invalid-feedback">Please provide an application name.</div>
                        </div>
                        <div class="form-group">
                            <label for="customerName"><strong>Customer Name</strong></label>
                            <input type="text" class="form-control" id="customerName" name="customer_name" required>
                            <div class="invalid-feedback">Please provide the customer's name.</div>
                        </div>
                        <div class="form-group">
                            <label for="customerMobile"><strong>Customer Mobile Number</strong></label>
                            <input type="text" class="form-control" id="customerMobile" name="customer_mobile_number" required>
                            <div class="invalid-feedback">Please provide the customer's mobile number.</div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="col-md-6">
                        <!-- *** CHANGE 1: Wrapped Total Commission input in a div with an ID *** -->
                        <div class="form-group" id="totalCommissionGroup">
                            <label for="totalCommission"><strong>Total Commission Amount (₹)</strong></label>
                            <input type="number" step="0.01" class="form-control" id="totalCommission" name="total_commission" required>
                            <div class="invalid-feedback">Please enter the total commission.</div>
                        </div>

                        <div class="form-group">
                            <label for="expectedDate"><strong>Expected Date of Completion</strong></label>
                            <input type="date" class="form-control" id="expectedDate" name="expected_date_of_completion">
                        </div>
                        <div class="form-group">
                            <label for="description"><strong>Work Description</strong></label>
                            <textarea class="form-control" id="description" name="description" rows="5" required></textarea>
                            <div class="invalid-feedback">Please provide a work description.</div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-3">
                    <button type="submit" class="btn btn-success btn-lg px-5">Create Application</button>
                </div>
            </form>
        </div>
    </div>

  <!-- Your Assigned Applications Section -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-info text-white">
      <h4>Your Assigned Applications</h4>
    </div>
    <div class="card-body">
      {% if applications %}
      <div class="row">
        {% for app in applications %}
        <div class="col-md-6 mb-3">
          <div class="card h-100">
            <div class="card-header">
              <strong>{{ app.application_name }}</strong>
              <span class="badge float-right {% if app.approved %}badge-success{% else %}badge-warning{% endif %}">
                {{ app.approved|yesno:"Approved,Pending" }}
              </span>
            </div>
            <div class="card-body">
              <p class="mb-1"><strong>Customer:</strong> {{ app.customer_name }}</p>
              <p class="mb-1"><strong>Created:</strong> {{ app.date_created|date:"d M Y" }}</p>
              <p><strong>Total Commission:</strong> ₹{{ app.total_commission|floatformat:2 }}</p>
            </div>
            <div class="card-footer">
                <a href="{% url 'application-detail' app.id %}" class="btn btn-sm btn-primary">View Details & Chat</a>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
        <p>You have not been assigned to any applications yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- Monthly Commissions Section -->
  <div class="card shadow-sm">
      <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
          <h4>Monthly Commissions</h4>
          <form method="get" class="form-inline">
              <label for="monthSelect" class="mr-2 mb-0 text-white">Month:</label>
              <select name="month" id="monthSelect" class="form-control form-control-sm mr-3" onchange="this.form.submit()">
                  {% for m in months %}<option value="{{ m.value }}" {% if m.value == selected_month %}selected{% endif %}>{{ m.display }}</option>{% endfor %}
              </select>
              <label for="yearSelect" class="mr-2 mb-0 text-white">Year:</label>
              <select name="year" id="yearSelect" class="form-control form-control-sm" onchange="this.form.submit()">
                  {% for y in years %}<option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>{% endfor %}
              </select>
          </form>
      </div>
      <div class="card-body">
            {% if approved_assignments %}
            <ul class="list-group mb-3">
                {% for assignment in approved_assignments %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        {{ assignment.application.application_name }}
                        <small class="text-muted">({{ assignment.application.date_created|date:"d M Y" }})</small>
                    </div>
                    <!-- Display the direct commission amount from the assignment -->
                    <span class="badge badge-primary badge-pill">₹{{ assignment.commission_amount|floatformat:2 }}</span>
                </li>
                {% endfor %}
            </ul>
            <h5 class="text-right">Total for {{ selected_month_display }} {{ selected_year }}: <strong>₹{{ total_commission|floatformat:2 }}</strong></h5>
            {% else %}
                <p>No approved commissions found for {{ selected_month_display }} {{ selected_year }}.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Helper function to update the total commission value
    function updateTotalCommission() {
        const creatorVal = parseFloat(document.getElementById('creatorShareAmount').value) || 0;
        const partnerVal = parseFloat(document.getElementById('partnerShareAmount').value) || 0;
        // Update the value of the (now hidden) total commission field
        document.getElementById('totalCommission').value = (creatorVal + partnerVal).toFixed(2);
    }

    // This function shows or hides the correct fields based on the dropdown
    function toggleSharingFields() {
        const assignType = document.getElementById('assignType').value;
        const sharingDiv = document.getElementById('sharingDiv');
        const totalCommissionGroup = document.getElementById('totalCommissionGroup');
        const totalCommissionInput = document.getElementById('totalCommission');
        const otherEmployee = document.getElementById('otherEmployee');
        const creatorShareAmount = document.getElementById('creatorShareAmount');
        const partnerShareAmount = document.getElementById('partnerShareAmount');

        if (assignType === 'sharing') {
            // Show sharing fields and hide the total commission field
            sharingDiv.style.display = 'block';
            totalCommissionGroup.style.display = 'none';
            
            // Set fields as required for validation
            otherEmployee.required = true;
            creatorShareAmount.required = true;
            partnerShareAmount.required = true;
            totalCommissionInput.required = false; // Not required from user

            // Add event listeners to auto-calculate the total
            creatorShareAmount.addEventListener('input', updateTotalCommission);
            partnerShareAmount.addEventListener('input', updateTotalCommission);
            updateTotalCommission(); // Run once to set initial value
        } else { // 'own' is selected
            // Hide sharing fields and show the total commission field
            sharingDiv.style.display = 'none';
            totalCommissionGroup.style.display = 'block';

            // Update required status
            otherEmployee.required = false;
            creatorShareAmount.required = false;
            partnerShareAmount.required = false;
            totalCommissionInput.required = true; // Required from user

            // Clean up event listeners
            creatorShareAmount.removeEventListener('input', updateTotalCommission);
            partnerShareAmount.removeEventListener('input', updateTotalCommission);
        }
    }

    // Bootstrap validation script
    (function () {
        'use strict'
        var form = document.getElementById('applicationForm');

        form.addEventListener('submit', function (event) {
            // No custom validation needed anymore, as the total is calculated automatically.
            // Standard HTML5 'required' validation is sufficient.
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
        
        // Set the initial state of the form on page load.
        toggleSharingFields();
    })();
</script>
{% endblock %}