{% extends "masteremployee.html" %}
{% load static %}

{% block content %}
<main class="container ml-sm-auto col-lg-12 px-4 py-4">

  <!-- Attendance Section -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5>Attendance for {{ employee.name }}</h5>
    </div>
    <div class="card-body">
      <h6>Login Sessions Today ({{ today|date:"d-m-Y" }})</h6>
      {% if todays_sessions %}
      <table class="table table-sm table-bordered mb-0">
        <thead class="thead-light">
          <tr>
            <th>ID</th>
            <th>Login Time</th>
            <th>Logout Time</th>
            <th>Duration</th>
            <th>Reason</th>
          </tr>
        </thead>
        <tbody>
          {% for session in todays_sessions %}
          <tr>
            <td>{{ session.id }}</td>
            <td>{{ session.login_time|time:"H:i" }}</td>
            <td>
              {% if session.logout_time %}
                {{ session.logout_time|time:"H:i" }}
              {% else %}
                <span class="text-warning">Active</span>
              {% endif %}
            </td>
            <td>{{ session.duration_str }}</td>
            <td>{{ session.logout_reason }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="p-3 mb-0">No login sessions found for today.</p>
      {% endif %}
    </div>
  </div>

  <!-- Date Filter Section -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <form method="get" class="form-inline">
        <label class="mr-2" for="month">Month:</label>
        <select class="form-control mr-3" id="month" name="month" onchange="this.form.submit()">
          {% for m in months %}
            <option value="{{ m.value }}" {% if m.value == selected_month %}selected{% endif %}>{{ m.display }}</option>
          {% endfor %}
        </select>
        <label class="mr-2" for="year">Year:</label>
        <select class="form-control" id="year" name="year" onchange="this.form.submit()">
          {% for y in years %}
            <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </form>
    </div>
  </div>

  <!-- Monthly Login Records -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-secondary text-white">
      <h6>Monthly Login Records for {{ selected_month_name }} {{ selected_year }}</h6>
    </div>
    <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
      {% if sessions_by_date %}
      <table class="table table-sm table-bordered table-striped mb-0">
        <thead class="thead-dark">
          <tr>
            <th>Date</th>
            <th>Login Sessions</th>
          </tr>
        </thead>
        <tbody>
          {% for date, sessions in sessions_by_date.items %}
          <tr>
            <td>{{ date }}</td>
            <td>
              <ul class="mb-0 pl-3">
                {% for session in sessions %}
                  <li>
                    <b>ID:</b> {{ session.id }}<br>
                    Login: {{ session.login_time|time:"H:i" }} -
                    Logout: {% if session.logout_time %}{{ session.logout_time|time:"H:i" }}{% else %}<span class="text-warning">Active</span>{% endif %}
                    <br>
                    <b>Duration:</b> {{ session.duration_str }}<br>
                    <b>Reason:</b> {{ session.logout_reason }}
                  </li>
                {% endfor %}
              </ul>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="2" class="text-center">Break Sessions</th>
          </tr>
          {% for bs in break_sessions %}
          <tr>
            <td>
              <b>ID:</b> {{ bs.id }}<br>
              {{ bs.start_time|date:"d-m-Y" }}<br>{{ bs.start_time|time:"H:i" }} -
              {% if bs.end_time %}
                {{ bs.end_time|time:"H:i" }}
              {% else %}
                <span class="text-warning">Active</span>
              {% endif %}
            </td>
            <td>
              Reason: {{ bs.logout_reason }}<br>
              Approved:
              {% if bs.approved %}
                <span class="badge badge-success">Approved</span>
              {% else %}
                <span class="badge badge-danger">Not Approved</span>
              {% endif %}
              <br>
              <b>Duration:</b> {{ bs.duration_str }}
            </td>
          </tr>
          {% endfor %}
        </tfoot>
      </table>
      {% else %}
      <p class="p-3 mb-0">No attendance records found for this period.</p>
      {% endif %}
    </div>
  </div>

  <!-- Monthly Salary -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5>Monthly Salary: ₹{{ calculated_salary|floatformat:2 }}</h5>
    <small>(Based on attended sessions and approved breaks during working hours out of {{ days_in_month }} days in {{ selected_month_name }})</small>
<div class="mt-2">
  <small class="text-muted">
    Working Hours: {{ employee.working_start_time|time:"H:i" }} - {{ employee.working_end_time|time:"H:i" }} 
    ({{ daily_working_hours|floatformat:1 }} hours/day)
  </small>
</div>
<div class="mt-1">
  <small class="text-muted">
    Expected Hours: {{ expected_hours|floatformat:1 }} hours ({{ days_in_month }} days × {{ daily_working_hours|floatformat:1 }} hours/day)
  </small>
</div>


  </div>
</div>
</main>
{% endblock %}
