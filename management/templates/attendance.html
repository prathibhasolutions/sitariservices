{% extends "masteremployee.html" %}
{% load static %}

{% block content %}
<main class="container ml-sm-auto col-lg-12 px-4 py-4">

    <!-- Date Filter Section -->
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <form method="get" class="form-inline">
          <label class="mr-2" for="month">Month:</label>
          <select class="form-control mr-3" id="month" name="month" onchange="this.form.submit()">
            {% for m in months %}
              <option value="{{ m.value }}" {% if m.value == selected_month %}selected{% endif %}>{{ m.display }}</option>
            {% endfor %}
          </select>
          <label class="mr-2" for="year">Year:</label>
          <select class="form-control" id="year" name="year" onchange="this.form.submit()">
            {% for y in years %}
              <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
        </form>
      </div>
    </div>

    <!-- NEW: Monthly Attendance Summary Table -->
    <div class="card mb-4 shadow-sm" id="monthly-summary-section">
        <div class="card-header d-flex justify-content-between align-items-center bg-dark text-white">
            <h5 class="mb-0">Monthly Attendance Summary</h5>
            <button class="btn btn-light btn-sm" onclick="printSummary()">
                <i class="fas fa-print"></i> Print Summary
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-striped mb-0">
                    <thead class="thead-light">
                        <tr>
                            <th>Sl.No</th>
                            <th>Date</th>
                            <th>Login Time</th>
                            <th>Logout Time</th>
                            <th>Break Sessions</th>
                            <th>Total Duration</th>
                            <th>Daily Wage (₹)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in daily_summary_records %}
                        <tr>
                            <td>{{ record.sl_no }}</td>
                            <td>{{ record.date|date:"d-m-Y" }}</td>
                            <td>{{ record.login_time|time:"H:i"|default:"-" }}</td>
                            <td>{{ record.logout_time|time:"H:i"|default:"-" }}</td>
                            <td>
                                {% if record.break_sessions %}
                                <ul class="list-unstyled mb-0 small">
                                    {% for break in record.break_sessions %}
                                    <li class="mb-1">
                                        {{ break.timings }} ({{ break.duration }}) - {{ break.reason }}
                                        {% if break.approved %}
                                            <span class="badge badge-success">A</span>
                                        {% else %}
                                            <span class="badge badge-danger">NA</span>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>{{ record.total_duration }}</td>
                            <td>{{ record.daily_wage|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="bg-light font-weight-bold">
                        <tr>
                            <td colspan="6" class="text-right">Total Monthly Wage:</td>
                            <td>₹{{ total_monthly_wage|floatformat:2 }}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Print-only header -->
    <div id="print-header" style="display: none;">
        <h4>Attendance Summary for {{ employee.name }}</h4>
        <p>{{ selected_month_name }} {{ selected_year }}</p>
    </div>

    <script>
    function printSummary() {
        var printHeader = document.getElementById('print-header').innerHTML;
        var printContents = document.getElementById('monthly-summary-section').innerHTML;
        var originalContents = document.body.innerHTML;

        // Temporarily replace body content with the header and the section to print
        document.body.innerHTML = printHeader + printContents;

        // Hide the print button in the printed version
        var printButton = document.body.querySelector('.btn-light');
        if(printButton) {
            printButton.style.display = 'none';
        }

        window.print();

        // Restore original content and reload to re-attach event listeners
        document.body.innerHTML = originalContents;
        window.location.reload();
    }
    </script>

    <!-- Original Attendance Section (Today's Sessions) -->
    <div class="card mb-4 shadow-sm" id="attendance-section">
      <div class="card-header bg-primary text-white">
          <h5>Attendance for Today ({{ today|date:"d-m-Y" }})</h5>
      </div>
      <div class="card-body">
          {% if todays_sessions %}
          <table class="table table-sm table-bordered mb-0">
              <thead class="thead-light">
                  <tr>
                      <th>ID</th>
                      <th>Login Time</th>
                      <th>Logout Time</th>
                      <th>Duration</th>
                      <th>Reason</th>
                  </tr>
              </thead>
              <tbody>
                  {% for session in todays_sessions %}
                  <tr>
                      <td>{{ session.id }}</td>
                      <td>{{ session.login_time|time:"H:i" }}</td>
                      <td>
                          {% if session.logout_time %}
                              {{ session.logout_time|time:"H:i" }}
                          {% else %}
                              <span class="text-warning">Active</span>
                          {% endif %}
                      </td>
                      <td>{{ session.duration_str }}</td>
                      <td>{{ session.logout_reason }}</td>
                  </tr>
                  {% endfor %}
              </tbody>
          </table>
          {% else %}
          <p class="mb-0">No login sessions found for today.</p>
          {% endif %}
      </div>
    </div>

    <!-- In attendance.html -->

<!-- UPDATED: Today's Salary Summary -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">Today's Salary Summary ({{ today|date:"d-m-Y" }})</h5>
    </div>
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="text-muted mb-0">Maximum Possible Daily Salary:</h6>
            <h5 class="mb-0">₹{{ max_daily_wage|floatformat:2 }}</h5>
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="font-weight-bold mb-0">Calculated Salary for Today:</h6>
            <h5 class="font-weight-bold mb-0">₹{{ todays_calculated_wage|floatformat:2 }}</h5>
        </div>
        <hr>
        <small class="text-muted">
            Salary is calculated based on your daily work duration (including approved breaks) within your scheduled working hours. A 2-hour break is factored into the calculation. The daily wage is capped and will not exceed the maximum possible daily salary.
        </small>
        <div class="mt-2">
            <small class="text-muted">
                Your Working Hours: {{ employee.working_start_time|time:"H:i" }} - {{ employee.working_end_time|time:"H:i" }} 
                ({{ daily_working_hours|floatformat:1 }} hours/day)
            </small>
        </div>
    </div>
</div>


</main>
{% endblock %}
