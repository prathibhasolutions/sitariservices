{% extends "masteremployee.html" %}
{% load static %}

{% block content %}
<main class="col-md-9 ml-sm-auto col-lg-10 px-4 py-4">

  <!-- Attendance Section -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5>Attendance for {{ employee.name }}</h5>
    </div>
    <div class="card-body">
      <h6>Login Sessions Today ({{ today|date:"d-m-Y" }})</h6>
      {% if todays_sessions %}
      <table class="table table-sm table-bordered mb-0">
        <thead class="thead-light">
          <tr>
            <th>Login Time</th>
            <th>Logout Time</th>
            <th>Duration</th>
          </tr>
        </thead>
        <tbody>
          {% for session in todays_sessions %}
          <tr>
            <td>{{ session.login_time|time:"H:i" }}</td>
            <td>
              {% if session.logout_time %}
                {{ session.logout_time|time:"H:i" }}
              {% else %}
                <span class="text-warning">Active</span>
              {% endif %}
            </td>
            <td>{{ session.duration_str }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="p-3 mb-0">No login sessions found for today.</p>
      {% endif %}
    </div>
  </div>

  <!-- Date Filter Section moved here -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <form method="get" class="form-inline">
        <label class="mr-2" for="month">Month:</label>
        <select class="form-control mr-3" id="month" name="month" onchange="this.form.submit()">
          {% for m in months %}
            <option value="{{ m.value }}" {% if m.value == selected_month %}selected{% endif %}>{{ m.display }}</option>
          {% endfor %}
        </select>
        <label class="mr-2" for="year">Year:</label>
        <select class="form-control" id="year" name="year" onchange="this.form.submit()">
          {% for y in years %}
            <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </form>
    </div>
  </div>

  <!-- Monthly Login Records -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-secondary text-white">
      <h6>Monthly Login Records for {{ selected_month_name }} {{ selected_year }}</h6>
    </div>
    <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
      {% if sessions_by_date %}
      <table class="table table-sm table-bordered table-striped mb-0">
        <thead class="thead-dark">
          <tr>
            <th>Date</th>
            <th>Login Sessions</th>
          </tr>
        </thead>
        <tbody>
          {% for date, sessions in sessions_by_date.items %}
          <tr>
            <td>{{ date }}</td>
            <td>
              <ul class="mb-0 pl-3">
                {% for session in sessions %}
                <li>
                  Login: {{ session.login_time|time:"H:i" }} - 
                  Logout: {% if session.logout_time %}{{ session.logout_time|time:"H:i" }}{% else %}<span class="text-warning">Active</span>{% endif %}
                  | Duration: {{ session.duration_str }}
                </li>
                {% endfor %}
              </ul>
            </td>
          </tr>
          {% endfor %}
        </tbody>

        <!-- Break Sessions -->
        <tfoot>
          <tr>
            <th colspan="2">Break Sessions</th>
          </tr>
          {% for bs in break_sessions %}
          <tr>
            <td>{{ bs.start_time|date:"d-m-Y" }}<br>{{ bs.start_time|time:"H:i" }} - {{ bs.end_time|time:"H:i" }}</td>
            <td>
              Reason: {{ bs.logout_reason }} <br>
              Approved: 
              {% if bs.approved %}
                <span class="badge badge-success">Approved</span>
              {% else %}
                <span class="badge badge-danger">Not Approved</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tfoot>
      </table>
      {% else %}
      <p class="p-3 mb-0">No attendance records found for this period.</p>
      {% endif %}
    </div>
  </div>

  

  <!-- Monthly Salary -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5>Monthly Salary: â‚¹{{ calculated_salary|floatformat:2 }}</h5>
      <small>(Based on attended sessions and approved breaks out of 25 working days)</small>
    </div>
  </div>

</main>


{% endblock %}
