{% load static %}
{% load upload_tags %}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Employee Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
   <!-- Bootstrap 4 (choose ONLY one version; here using v4.6.2 as requested) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Bootstrap Icons (for icon utilities) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<!-- Font Awesome 6 (latest icon support, do NOT mix with v4.7) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- Google Fonts: Open Sans, Roboto, Poppins, Raleway -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100..900&family=Poppins:wght@100..900&family=Raleway:wght@100..900&family=Open+Sans:wght@300..700&display=swap" rel="stylesheet">
<meta name="csrf-token" content="{{ csrf_token }}">
  <style>
    body {
        /* A light, neutral background for the main content area */
        background-color: #f8f9fa;
        /* Prevent body from scrolling, as the main section will handle it */
        overflow: hidden; 
    }

    /* === Sticky Navbar === */
    .navbar {
        background: linear-gradient(135deg, #0062E0 0%, #19AFFF 100%) !important;
        position: sticky;
        top: 0;
        z-index: 1030; /* Ensures it stays above other content */
    }
    
    /* === Sidebar: Solid Dark Slate Blue === */
.sidebar {
    position: fixed;
    top: 76px; /* Adjust to your navbar's height */
    bottom: 0;
    left: 0;
    z-index: 1020;
    color: #fff;
    overflow-y: auto;
    /* A clean, professional dark blue */
    background-color: #2c3e50; 
}

.sidebar .nav-link {
    color: #fff;
    transition: background-color 0.2s ease-in-out;
}

.sidebar .nav-link.active, 
.sidebar .nav-link:hover {
    /* A slightly lighter blue for the hover/active state */
    background-color: #067ac7;
}

    
    /* === Main Content Area - The only scrollable part === */
    main.col-md-10 {
        /* Height is viewport height minus navbar height */
        height: calc(100vh - 76px); 
        /* This makes the main content area scrollable */
        overflow-y: auto;
        padding-top: 1.5rem;
    }

    /* === Responsive behavior for mobile === */
    @media (max-width: 767.98px) {
        body {
            overflow: auto; /* Re-enable body scrolling on mobile */
        }
        .sidebar {
            position: static; /* Return to normal flow */
            height: auto;
            min-height: auto;
        }
        main.col-md-10 {
            height: auto; /* Let content determine height */
            overflow-y: visible;
        }
    }
    
   /* === Enhanced Notification Bell === */
    .navbar-bell {
        position: relative;
        margin-right: 25px; /* Added more space on the right */
        cursor: pointer;
    }

    .navbar-bell a {
        color: white;
        transition: color 0.3s ease;
    }

    .navbar-bell a:hover {
        /* A subtle gold color on hover for a premium feel */
        color: #ffd700; 
    }

    /* The bell icon itself */
    .navbar-bell .fa-bell {
        font-size: 1.8rem; /* Increased icon size */
        transition: transform 0.2s ease-in-out;
    }

    /* Animate the bell on hover */
    .navbar-bell:hover .fa-bell {
        /* Creates a subtle "wobble" effect */
        transform: rotate(15deg);
    }

    /* The notification count badge */
    .navbar-bell .badge {
        position: absolute;
        top: -8px;
        right: -15px;
        font-size: 0.8rem; /* Larger font */
        font-weight: 600;
        padding: 4px 7px; /* More padding */
        border-radius: 50%;
        /* Adds a subtle "glow" to the badge */
        box-shadow: 0 0 10px rgba(220, 53, 69, 0.8);
    }

    /* === New styles for the Upload Icon === */
.navbar-upload-icon {
    font-size: 1.9rem; /* Makes the icon a bit larger */
    color: white;
    transition: color 0.3s ease;
}

.navbar-upload-icon:hover {
    color: #ffd700; /* Gold hover color, same as notification bell */
}


    /* Logo styles (no change) */
    .navbar-logo {
        width: 80px;
        height: 80px;
        object-fit: cover;
    }
</style>


</head>


<body>
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<nav class="navbar navbar-dark bg-primary d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
        <!-- Sidebar toggler for mobile -->
        <button class="navbar-toggler d-md-none mr-2" type="button" data-toggle="collapse" data-target="#sidebarCollapse" aria-controls="sidebarCollapse" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

         <!-- === Logo Added Here === -->
        <img src="{% static '/management/img/logo.jpg' %}" alt="Logo" class="navbar-logo rounded-circle mr-4">
        <span class="navbar-brand mb-0 h1">Employee Dashboard</span>
    </div>
    
    {# This div groups the icons together on the right #}
<div class="d-flex align-items-center">
    <a href="{% url 'todo_page' %}" class="mr-4" title="Task Reminder">
    <i class="fas fa-list-check navbar-upload-icon"></i>
</a>


    {# 1. Upload Icon (now on the left) #}
    <a href="#" class="mr-4" data-toggle="modal" data-target="#uploadFileModal" title="Upload Files">
        <i class="fas fa-upload navbar-upload-icon"></i>
    </a>

    {# 2. Notification Bell Icon #}
    <div class="navbar-bell">
        <a href="{% url 'notification_list' %}" class="text-white" title="View Notifications">
            <i class="fas fa-bell fa-lg"></i>
            {% if unread_notification_count > 0 %}
                <span class="badge badge-danger">{{ unread_notification_count }}</span>
            {% endif %}
        </a>
    </div>

</div>


</nav>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
<nav class="col-md-2 bg-dark sidebar py-4 collapse d-md-block" id="sidebarCollapse">
    <div class="nav flex-column">
        <br>
        {% url 'employee_dashboard' as profile_url %}
        <a class="nav-link mb-2 {% if request.path == profile_url %}active{% endif %}" href="{{ profile_url }}">Profile</a>

        {% url 'attendance' as attendance_url %}
        <a class="nav-link mb-2 {% if request.path == attendance_url %}active{% endif %}" href="{{ attendance_url }}">Attendance</a>
        
        {% url 'applications' as applications_url %}
        <a class="nav-link mb-2 {% if request.path == applications_url %}active{% endif %}" href="{{ applications_url }}">Applications</a>

        {% url 'worksheet' as worksheet_url %}
        <a class="nav-link mb-2 {% if request.path == worksheet_url %}active{% endif %}" href="{{ worksheet_url }}">Worksheet</a>

        <a class="nav-link mb-2" href="https://app.interakt.ai/login" target="_blank" rel="noopener">Interakt</a>

        {% url 'create_invoice' as invoice_url %}
        <a class="nav-link mb-2 {% if request.path == invoice_url %}active{% endif %}" href="{{ invoice_url }}">Generate Invoice</a>

        {% url 'assigned_links' as links_url %}
        <a class="nav-link mb-2 {% if request.path == links_url %}active{% endif %}" href="{{ links_url }}">Links</a>

        {% url 'change_password_request' as change_pass_url %}
        <a class="nav-link mb-2 {% if request.path == change_pass_url %}active{% endif %}" href="{{ change_pass_url }}">Change Password</a>

        <a href="#" class="nav-link text-danger mt-3" data-toggle="modal" data-target="#logoutModal">Logout</a>
    </div>
</nav>

        <!-- Main content area -->
        <main class="col-md-10 ml-sm-auto col-lg-10 px-4 py-4">
            {% block content %}
            {% endblock %}
        </main>
    </div>
</div>
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <form id="logoutForm" method="post" action="{% url 'logout' %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logoutModalLabel">Reason for Logout</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="text" name="logout_reason" class="form-control" placeholder="Enter reason for logout" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Logout</button>
        </div>
      </div>
    </form>
  </div>
</div>
<!--
<script>
let idleSeconds = 0;
let isActive = true;

// This will work because it's in the template
const loginUrl = "{% url 'login' %}";

function resetIdle() {
    idleSeconds = 0;
    isActive = true;
    console.log('User activity detected, idle timer reset');
}

// Track only scroll, click, and typing activities
const events = ['click', 'keypress', 'keydown', 'scroll', 'touchstart'];
events.forEach(event => {
    document.addEventListener(event, resetIdle, true);
});

// Get CSRF token safely
function getCSRFToken() {
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        return csrfMeta.getAttribute('content');
    }

    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }

    const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (csrfInput) {
        return csrfInput.value;
    }

    return null;
}

// Auto-logout function
function performAutoLogout() {
    const csrftoken = getCSRFToken();

    if (!csrftoken) {
        console.error('CSRF token not found, redirecting directly');
        window.location.href = loginUrl;
        return;
    }

    console.log('Performing auto-logout due to inactivity');

    const formData = new FormData();
    formData.append('logout_reason', 'Auto-logout: Employee idle for more than 5min');

    fetch('/logout/', {
        method: 'POST',
        headers: {
            "X-CSRFToken": csrftoken,
        },
        body: formData
    })
        .then(response => {
            console.log('Logout response:', response.status);
            if (response.ok || response.redirected) {
                window.location.href = loginUrl;
            } else {
                console.error('Logout failed with status:', response.status);
                window.location.href = loginUrl;
            }
        })
        .catch(error => {
            console.error('Logout error:', error);
            window.location.href = loginUrl;
        });
}

// Main idle timer (now 5 minutes = 300 seconds)
setInterval(function () {
    if (isActive) {
        idleSeconds++;

        if (idleSeconds % 10 === 0) {
            console.log(`User idle for ${idleSeconds} seconds`);
        }

        if (idleSeconds === 290) {
            console.log('Warning: Auto-logout in 10 seconds due to inactivity');
        }

        if (idleSeconds >= 3000) {
            isActive = false;
            performAutoLogout();
        }
    }
}, 1000);

console.log('Idle timeout script initialized - will redirect to:', loginUrl);
</script>

<script>
function getCSRFToken() {
    // Try to get csrf token from meta first
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta) return meta.getAttribute('content');
    // Fallback: from cookie
    let matches = document.cookie.match(/csrftoken=([^;]+)/);
    return matches ? matches[1] : null;
}

setInterval(function() {
    fetch("/employee/attendance_ping/", {
        method: "POST",
        headers: {
            "X-CSRFToken": getCSRFToken(),
        },
    });
}, 5000); // Ping every 30 seconds
</script>-->


<!-- File Upload Modal -->
<div class="modal fade" id="uploadFileModal" tabindex="-1" role="dialog" aria-labelledby="uploadFileModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form method="post" action="{% url 'upload_file' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="uploadFileModalLabel">Upload a Document</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          {# Get the form instance from our custom template tag #}
          {% get_upload_form as upload_form %}

          {# Loop through the fields to render them automatically #}
          {% for field in upload_form %}
            <div class="form-group">
              <label for="{{ field.id_for_label }}">{{ field.label }}</label>
              {{ field }}
              {% for error in field.errors %}
                  <div class="alert alert-danger p-1 mt-1">{{ error }}</div>
              {% endfor %}
            </div>
          {% endfor %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Upload File</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ============================================================================== -->
<!-- ======================= FINAL BRUTE-FORCE REMINDER ======================= -->
<!-- ============================================================================== -->

<!-- 1. The Audio Element -->
<audio id="reminderAudio" loop>
    <source src="{% static 'management/sound/alert.mp3' %}" type="audio/mpeg">
</audio>

<!-- 2. The Bootstrap Modal -->
<div class="modal fade" id="reminderModal" data-backdrop="static" data-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"> TASK REMINDER!</h5>
            </div>
            <div class="modal-body" id="reminderModalBody" style="font-size: 1.1rem; font-weight: 500;">
                <!-- Task description goes here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="acknowledgeBtn">Clear Reminder</button>
            </div>
        </div>
    </div>
</div>

<!-- 3. The Brute-Force JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        console.log("[Brute-Force Reminder] System Initialized.");

        const audio = document.getElementById('reminderAudio');
        const reminderModal = $('#reminderModal');
        const modalBody = document.getElementById('reminderModalBody');
        const acknowledgeBtn = document.getElementById('acknowledgeBtn');
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        let audioEnabled = false;

        // Enable audio on the first user click
        document.body.addEventListener('click', () => {
            if (!audioEnabled) {
                audio.play().then(() => {
                    audio.pause();
                    audio.currentTime = 0;
                    audioEnabled = true;
                    console.log("[Brute-Force Reminder] Audio enabled.");
                }).catch(e => console.error("[Brute-Force Reminder] Audio could not be enabled.", e));
            }
        }, { once: true });

        // Function to handle a single overdue task
        async function handleOverdueTask(task) {
            return new Promise(resolve => {
                console.log(`[Brute-Force Reminder] Alerting for overdue task: "${task.description}"`);

                // Set the modal content
                modalBody.textContent = `This task is overdue: "${task.description}"`;

                // Show the modal and play the sound
                reminderModal.modal('show');
                if (audioEnabled) {
                    audio.play();
                }

                // Acknowledge button logic
                acknowledgeBtn.onclick = async () => {
                    // Stop the audio and hide the modal
                    audio.pause();
                    audio.currentTime = 0;
                    reminderModal.modal('hide');

                    // Delete the task from the server
                    try {
                        await fetch(`/api/todos/delete/${task.id}/`, {
                            method: 'POST',
                            headers: { 'X-CSRFToken': csrfToken }
                        });
                        console.log(`[Brute-Force Reminder] Task ${task.id} deleted.`);
                    } catch (error) {
                        console.error("[Brute-Force Reminder] Failed to delete task:", error);
                    } finally {
                        // Resolve the promise to move to the next overdue task
                        resolve();
                    }
                };
            });
        }

        // Main function to check all overdue tasks on page load
        async function checkAllOverdueTasks() {
            console.log("[Brute-Force Reminder] Checking for any overdue tasks on page load...");
            try {
                const response = await fetch("{% url 'todos_get' %}");
                const data = await response.json();
                const now = new Date();

                const overdueTasks = data.todos.filter(task => new Date(task.due_time) <= now);

                if (overdueTasks.length > 0) {
                    console.log(`[Brute-Force Reminder] Found ${overdueTasks.length} overdue tasks.`);
                    // Handle each overdue task one by one, waiting for acknowledgment
                    for (const task of overdueTasks) {
                        await handleOverdueTask(task);
                    }
                    console.log("[Brute-Force Reminder] All overdue tasks have been handled.");
                } else {
                    console.log("[Brute-Force Reminder] No overdue tasks found.");
                }
            } catch (error) {
                console.error("[Brute-Force Reminder] Error checking for overdue tasks:", error);
            }
        }

        // Run the check when the page is loaded
        await checkAllOverdueTasks();
    });
</script>

<!-- ============================================================================ -->
<!-- ======================= END OF BRUTE-FORCE REMINDER ====================== -->
<!-- ============================================================================ -->


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
