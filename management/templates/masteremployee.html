{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Employee Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
   <!-- Bootstrap 4 (choose ONLY one version; here using v4.6.2 as requested) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Bootstrap Icons (for icon utilities) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<!-- Font Awesome 6 (latest icon support, do NOT mix with v4.7) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- Google Fonts: Open Sans, Roboto, Poppins, Raleway -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100..900&family=Poppins:wght@100..900&family=Raleway:wght@100..900&family=Open+Sans:wght@300..700&display=swap" rel="stylesheet">
<meta name="csrf-token" content="{{ csrf_token }}">
    <style>
        body { min-height: 100vh; }
        .sidebar {
            min-height: 100vh;
            background: #343a40;
            color: #fff;
        }
        .sidebar .nav-link {
            color: #fff;
        }
        .sidebar .nav-link.active, .sidebar .nav-link:hover {
            background-color: #495057;
        }
        @media (max-width: 767.98px) {
            .sidebar { min-height: auto; }
        }
        /* Notification bell and badge for navbar */
        .navbar-bell {
            position: relative;
        }
        .navbar-bell .badge {
            position: absolute;
            top: 0.1rem;
            right: -0.3rem;
            font-size: 0.7rem;
            z-index: 10;
        }
    </style>
</head>
<body>
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<nav class="navbar navbar-dark bg-primary d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
        <!-- Sidebar toggler for mobile -->
        <button class="navbar-toggler d-md-none mr-2" type="button" data-toggle="collapse" data-target="#sidebarCollapse" aria-controls="sidebarCollapse" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <span class="navbar-brand mb-0 h1">Employee Dashboard</span>
    </div>
    

</nav>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-2 bg-dark sidebar py-4 collapse d-md-block" id="sidebarCollapse">
            <div class="nav flex-column">
                <a class="nav-link active mb-2" href="{% url 'employee_dashboard' %}">Profile</a>
                <a class="nav-link mb-2" href="{% url 'attendance' %}">Attendance</a>
                <a class="nav-link mb-2" href="{% url 'applications' %}">Applications</a>
                <a class="nav-link mb-2" href="https://app.interakt.ai/login" target="_blank" rel="noopener">Interakt</a>
                <a class="nav-link mb-2" href="{% url 'create_invoice' %}">Generate Invoice</a>
                <a class="nav-link mb-2" href="{% url 'links' %}">Links</a>
                <a href="#" class="nav-link text-danger mt-3" data-toggle="modal" data-target="#logoutModal">Logout</a>
            </div>
        </nav>
        <!-- Main content area -->
        <main class="col-md-10 ml-sm-auto col-lg-10 px-4 py-4">
            {% block content %}
            {% endblock %}
        </main>
    </div>
</div>
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <form id="logoutForm" method="post" action="{% url 'logout' %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logoutModalLabel">Reason for Logout</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="text" name="logout_reason" class="form-control" placeholder="Enter reason for logout" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Logout</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
let idleSeconds = 0;
let isActive = true;

// This will work because it's in the template
const loginUrl = "{% url 'login' %}";

function resetIdle() {
    idleSeconds = 0;
    isActive = true;
    console.log('User activity detected, idle timer reset');
}

// Track only scroll, click, and typing activities
const events = ['click', 'keypress', 'keydown', 'scroll', 'touchstart'];
events.forEach(event => {
    document.addEventListener(event, resetIdle, true);
});

// Get CSRF token safely
function getCSRFToken() {
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        return csrfMeta.getAttribute('content');
    }

    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }

    const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (csrfInput) {
        return csrfInput.value;
    }

    return null;
}

// Auto-logout function
function performAutoLogout() {
    const csrftoken = getCSRFToken();

    if (!csrftoken) {
        console.error('CSRF token not found, redirecting directly');
        window.location.href = loginUrl;
        return;
    }

    console.log('Performing auto-logout due to inactivity');

    const formData = new FormData();
    formData.append('logout_reason', 'Auto-logout: Employee idle for more than 5min');

    fetch('/logout/', {
        method: 'POST',
        headers: {
            "X-CSRFToken": csrftoken,
        },
        body: formData
    })
        .then(response => {
            console.log('Logout response:', response.status);
            if (response.ok || response.redirected) {
                window.location.href = loginUrl;
            } else {
                console.error('Logout failed with status:', response.status);
                window.location.href = loginUrl;
            }
        })
        .catch(error => {
            console.error('Logout error:', error);
            window.location.href = loginUrl;
        });
}

// Main idle timer (now 5 minutes = 300 seconds)
setInterval(function () {
    if (isActive) {
        idleSeconds++;

        if (idleSeconds % 10 === 0) {
            console.log(`User idle for ${idleSeconds} seconds`);
        }

        if (idleSeconds === 290) {
            console.log('Warning: Auto-logout in 10 seconds due to inactivity');
        }

        if (idleSeconds >= 300) {
            isActive = false;
            performAutoLogout();
        }
    }
}, 1000);

console.log('Idle timeout script initialized - will redirect to:', loginUrl);
</script>

<script>
function getCSRFToken() {
    // Try to get csrf token from meta first
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta) return meta.getAttribute('content');
    // Fallback: from cookie
    let matches = document.cookie.match(/csrftoken=([^;]+)/);
    return matches ? matches[1] : null;
}

setInterval(function() {
    fetch("/employee/attendance_ping/", {
        method: "POST",
        headers: {
            "X-CSRFToken": getCSRFToken(),
        },
    });
}, 3000); // Ping every 30 seconds
</script>




<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
