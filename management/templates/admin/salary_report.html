{% extends "admin/base_site.html" %}
{% load static humanize %}

{% block extrahead %}
  {# This block adds custom CSS for printing #}
  {{ block.super }}
  <style>
    @media print {
      /* --- 1. Set Page Layout to Portrait --- */
      @page {
        size: A4 portrait; /* Ensure portrait orientation */
        margin: 0.6in 0.4in; /* Margins for portrait mode */
      }

      body {
        font-size: 9.5pt; /* Slightly smaller base font */
      }

      /* --- 2. Force Side-by-Side Columns with Flexbox --- */
      .row {
        display: flex;
        flex-wrap: nowrap; /* Prevent columns from stacking */
        width: 100%;
      }
      .col-lg-6 {
        width: 50% !important; /* Each column is half the page width */
        flex: 0 0 50%;
        padding-left: 8px !important;
        padding-right: 8px !important;
      }
      
      /* --- 3. Hide Unnecessary Elements --- */
      #header, #nav-sidebar, #changelist-search, footer, .object-tools a, .btn {
        display: none !important;
      }

      /* --- 4. Compact Styling for Cards and Tables --- */
      #content-main {
        width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
      }
      .card {
        page-break-inside: avoid; /* Don't split cards across pages */
        border: 1px solid #ccc !important;
        box-shadow: none !important;
        margin-bottom: 12px;
      }
      .card-body {
        padding: 6px !important; /* Tighter padding */
      }
      h3, h5 {
        color: #000 !important;
        font-size: 10pt;
        margin-bottom: 6px;
      }
      h3 { font-size: 13pt; }

      th, td {
        padding: 4px !important; /* Tighter cell padding */
        font-size: 8.5pt !important;
      }
      th {
        font-weight: bold;
      }
    }
  </style>
{% endblock %}


{% block content %}
<div id="content-main">
    
    {# Report Header #}
    {% if selected_employee %}
        <h3>Report for: {{ selected_employee.name }} | Month: {{ selected_date|date:"F Y" }}</h3>
    {% endif %}

    <!-- Filter Form (Hidden in Print) -->
    <form method="get" id="changelist-search" class="mb-4">
        <div class="d-flex align-items-center flex-wrap">
            <div class="form-group mr-3">
                <label for="employee-select" class="mr-2">Select Employee:</label>
                <select name="employee" id="employee-select" class="form-control" onchange="this.form.submit()">
                    <option value="">---------</option>
                    {% for emp in all_employees %}
                        <option value="{{ emp.pk }}" {% if selected_employee.pk == emp.pk %}selected{% endif %}>
                            {{ emp.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group mr-3">
                <label for="year-select" class="mr-2">Select Year:</label>
                <select name="year" id="year-select" class="form-control">
                    {% for y in available_years %}
                        <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>
                            {{ y }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group mr-3">
                <label for="month-select" class="mr-2">Select Month:</label>
                <select name="month_select" id="month-select" class="form-control">
                    <option value="1" {% if selected_month == 1 %}selected{% endif %}>January</option>
                    <option value="2" {% if selected_month == 2 %}selected{% endif %}>February</option>
                    <option value="3" {% if selected_month == 3 %}selected{% endif %}>March</option>
                    <option value="4" {% if selected_month == 4 %}selected{% endif %}>April</option>
                    <option value="5" {% if selected_month == 5 %}selected{% endif %}>May</option>
                    <option value="6" {% if selected_month == 6 %}selected{% endif %}>June</option>
                    <option value="7" {% if selected_month == 7 %}selected{% endif %}>July</option>
                    <option value="8" {% if selected_month == 8 %}selected{% endif %}>August</option>
                    <option value="9" {% if selected_month == 9 %}selected{% endif %}>September</option>
                    <option value="10" {% if selected_month == 10 %}selected{% endif %}>October</option>
                    <option value="11" {% if selected_month == 11 %}selected{% endif %}>November</option>
                    <option value="12" {% if selected_month == 12 %}selected{% endif %}>December</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">View Report</button>
            {% if selected_employee %}
                <button type="button" onclick="window.print();" class="btn btn-secondary ml-3">Print Report</button>
            {% endif %}
        </div>
    </form>

    {% if selected_employee %}
        <!-- Top Row: Profile and Earnings -->
        <div class="row mt-3">
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Profile Details</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped mb-0">
                                <tbody>
                                    <tr><th scope="row" style="width: 40%;">Employee Name</th><td>{{ selected_employee.name }}</td></tr>
                                    <tr><th scope="row">Mobile Number</th><td>{{ selected_employee.mobile_number }}</td></tr>
                                    <tr><th scope="row">Department</th><td>{{ selected_employee.department.name|default_if_none:"Not set" }}</td></tr>
                                    <tr><th scope="row">Salary Month</th><td>{{ selected_date|date:"F Y" }}</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Earnings Breakdown</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0">
                                <tbody>
                                    <tr><th scope="row" style="width: 50%;">Attendance-Based Salary</th><td>₹{{ current_month_earnings.attendance_salary|floatformat:0|intcomma }}</td></tr>
                                    <tr><th scope="row">Application Commissions</th><td>₹{{ current_month_earnings.application_commissions|floatformat:0|intcomma }}</td></tr>
                                    <tr>
                                        <th scope="row">
                                            {% if selected_employee.department.name == 'Xerox' %}
                                                Worksheet Commissions (5%)
                                            {% else %}
                                                Worksheet Commissions (5%)
                                            {% endif %}
                                        </th>
                                        <td>₹{{ current_month_earnings.worksheet_commissions|floatformat:0|intcomma }}</td>
                                    </tr>
                                    <tr class="table-success"><th scope="row">Meetings Bonus</th><td>₹{{ current_month_earnings.meetings_bonus|floatformat:0|intcomma }}</td></tr>
                                    <tr class="table-success"><th scope="row">Trainings Bonus</th><td>₹{{ current_month_earnings.trainings_bonus|floatformat:0|intcomma }}</td></tr>
                                    <tr class="table-success"><th scope="row">Performance Bonus</th><td>₹{{ current_month_earnings.performance_bonus|floatformat:0|intcomma }}</td></tr>
                                    <tr class="table-success"><th scope="row">Extra Days Bonus</th><td>₹{{ current_month_earnings.extra_days_bonus|floatformat:0|intcomma }}</td></tr>
                                    <tr class="table-danger"><th scope="row">Total Deductions</th><td>- ₹{{ current_month_earnings.deduction_amount|floatformat:0|intcomma }}</td></tr>
                                    <tr class="table-info"><th scope="row">Total This Month</th><td><strong>₹{{ current_month_earnings.total_earnings|floatformat:0|intcomma }}</strong></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Row: Advances and Meetings -->
        <div class="row mt-4">
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Advances</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0">
                                <tbody>
                                    <tr><th scope="row" style="width: 40%;">Total Outstanding Advance</th><td><strong>₹{{ selected_employee.advances|floatformat:0|intcomma }}</strong></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Meetings Attended</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0">
                                <thead><tr><th>Date</th><th>Topic</th><th>Bonus Earned</th></tr></thead>
                                <tbody>
                                    {% for attendance in attended_meetings %}
                                    <tr>
                                        <td>{{ attendance.meeting.date|date:"d M Y" }}</td>
                                        <td>{{ attendance.meeting.topic }}</td>
                                        <td>₹{{ attendance.meeting.amount|floatformat:0|intcomma }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="3" class="text-center text-muted">No meetings attended this month.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Third Row: Trainings and Performance Bonuses -->
        <div class="row mt-4">
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Trainings This Month</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0">
                                <thead><tr><th>Date</th><th>Reason</th><th>Bonus Earned</th></tr></thead>
                                <tbody>
                                    {% for training in attended_trainings %}
                                        <tr>
                                            <td>{{ training.date|date:"d M Y" }}</td>
                                            <td>{{ training.reason }}</td>
                                            <td>₹{{ training.amount|floatformat:0|intcomma }}</td>
                                        </tr>
                                    {% empty %}
                                        <tr><td colspan="3" class="text-muted text-center">No trainings this month.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Performance Bonuses This Month</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0">
                                <thead><tr><th>Date</th><th>Reason</th><th>Bonus Earned</th></tr></thead>
                                <tbody>
                                    {% for bonus in performance_bonuses %}
                                        <tr>
                                            <td>{{ bonus.date|date:"d M Y" }}</td>
                                            <td>{{ bonus.reason }}</td>
                                            <td>₹{{ bonus.amount|floatformat:0|intcomma }}</td>
                                        </tr>
                                    {% empty %}
                                        <tr><td colspan="3" class="text-muted text-center">No performance bonuses this month.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fourth Row: Extra Days Bonuses -->
        <div class="row mt-4">
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Extra Days Bonuses This Month</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0">
                                <thead><tr><th>Date</th><th>Reason</th><th>Bonus Earned</th></tr></thead>
                                <tbody>
                                    {% for bonus in extra_days_bonuses %}
                                        <tr>
                                            <td>{{ bonus.date|date:"d M Y" }}</td>
                                            <td>{{ bonus.reason }}</td>
                                            <td>₹{{ bonus.amount|floatformat:0|intcomma }}</td>
                                        </tr>
                                    {% empty %}
                                        <tr><td colspan="3" class="text-muted text-center">No extra days bonuses this month.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Empty column to balance the row -->
            <div class="col-lg-6 mb-4">
            </div>
        </div>
    {% else %}
        <p>Please select an employee and a month to view their salary report.</p>
    {% endif %}
</div>
{% endblock %}
