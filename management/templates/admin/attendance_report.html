{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div id="content-main">
    

    <!-- 1. Filter Form -->
    <form method="get" id="report-form" style="margin-bottom: 20px;">
        <div class="form-row" style="display: flex; align-items: flex-end;">
            <div>
                <label for="employee-select">Select Employee:</label>
                <select id="employee-select" name="employee_id">
                    <option value="">---------</option>
                    {% for emp in all_employees %}
                        <option value="{{ emp.pk }}" {% if selected_employee.pk == emp.pk %}selected{% endif %}>
                            {{ emp.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div style="margin-left: 20px;">
                <label for="month-select">Select Month:</label>
                <input type="month" id="month-select" name="month" value="{{ selected_month_str }}">
            </div>
            <div style="margin-left: 20px;">
                <input type="submit" value="Generate Report">
            </div>
        </div>
    </form>

    <hr>

    <!-- 2. Report Section -->
    {% if selected_employee and daily_summary_records %}
    <div id="printable-report">
        <!-- Header for printing -->
        <div id="print-header" style="display: none; text-align: center; margin-bottom: 20px;">
            <h2>Attendance Report for {{ selected_employee.name }}</h2>
            <p><strong>Month:</strong> {% firstof selected_month_str 'N/A' %}</p>
        </div>

        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #f2f2f2;">
                    <th style="padding: 8px; border: 1px solid #ddd;">Sl.No</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">Date</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">Login Time</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">Logout Time</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">Break Sessions</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">Total Duration</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">Daily Wage (₹)</th>
                </tr>
            </thead>
            <tbody>
                {% for record in daily_summary_records %}
                <tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">{{ record.sl_no }}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">{{ record.date|date:"d-m-Y" }}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">{{ record.login_time|time:"H:i"|default:"-" }}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">{{ record.logout_time|time:"H:i"|default:"-" }}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">
                        {% if record.break_sessions %}
                        <ul style="padding-left: 15px; margin: 0;">
                            {% for break in record.break_sessions %}
                            <li>
                                {{ break.timings }} ({{ break.duration }}) - {{ break.reason }}
                                {% if break.approved %}<b>(A)</b>{% else %}(NA){% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd;">{{ record.total_duration }}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">{{ record.daily_wage|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr style="font-weight: bold; background-color: #f2f2f2;">
                    <td colspan="6" style="padding: 8px; border: 1px solid #ddd; text-align: right;">Total Monthly Wage:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">₹{{ total_monthly_wage|floatformat:2 }}</td>
                </tr>
            </tfoot>
        </table>
    </div>
    
    <div style="margin-top: 20px;">
        <button onclick="printReport()" id="print-button">Print Report</button>
    </div>

    {% elif request.GET.employee_id %}
        <p>No attendance records found for the selected employee and month.</p>
    {% endif %}

</div>

<script>
function printReport() {
    var printHeader = document.getElementById('print-header');
    var reportContent = document.getElementById('printable-report');
    var originalContent = document.body.innerHTML;

    // Temporarily show the header and hide the button for printing
    printHeader.style.display = 'block';
    document.getElementById('report-form').style.display = 'none';
    document.getElementById('print-button').style.display = 'none';
    document.querySelector('h1').style.display = 'none';
    document.querySelector('hr').style.display = 'none';
    
    document.body.innerHTML = reportContent.innerHTML;

    window.print();
    
    // Restore the original page content
    document.body.innerHTML = originalContent;
    // Reload to ensure all scripts and event handlers work correctly
    window.location.reload();
}
</script>

{% endblock %}
