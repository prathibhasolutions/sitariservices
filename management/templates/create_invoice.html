{% extends "masteremployee.html" %}
{% block content %}
<main class="container py-4">
  <div class="card">
    <div class="card-body">
      <h3 class="mb-4">Generate Invoice</h3>
      <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <h5>Particulars</h5>
        {{ formset.management_form }}
        <table class="table" id="invoice-items-table">
          <thead>
            <tr>
              <th>Description</th>
              <th>Amount (₹)</th>
              <th>Remove</th>
            </tr>
          </thead>
          <tbody id="formset-body">
            {% for particular_form in formset %}
            <tr class="formset-row">
              <td>{{ particular_form.description }}</td>
              <td>{{ particular_form.amount }}</td>
              <td>
                <button type="button" class="btn btn-danger remove-row">Remove</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <button type="button" class="btn btn-secondary mb-2" id="add-row">Add Particular</button>
        <div class="mt-3">
          <strong>Total: ₹<span id="invoice-total">0.00</span></strong>
        </div>
        <button type="submit" class="btn btn-primary mt-2">Create Invoice</button>
      </form>
    </div>
  </div>
</main>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
let formIdx = {{ formset.total_form_count }};
$('#add-row').click(function() {
    let row = $('.formset-row:first').clone(false, false);
    row.find('input').each(function() {
        let name = $(this).attr('name').replace(/-\d+-/, `-${formIdx}-`);
        $(this).attr({'name': name, 'id': 'id_' + name}).val('');
    });
    row.find('input[type="hidden"]').remove(); // Remove hidden PKs for new rows
    $('#formset-body').append(row);
    $('input[name="form-TOTAL_FORMS"]').val(++formIdx);
    updateTotal();
});
$('#invoice-items-table').on('click', '.remove-row', function() {
    if ($('#formset-body .formset-row').length > 1) {
        $(this).closest('tr').remove();
        updateTotal();
    }
});
function updateTotal() {
    let total = 0;
    $('#formset-body .formset-row').each(function() {
        let val = parseFloat($(this).find('input[name$="-amount"]').val()) || 0;
        total += val;
    });
    $('#invoice-total').text(total.toFixed(2));
}
$('#formset-body').on('input', 'input[name$="-amount"]', updateTotal);
$(document).ready(updateTotal);
</script>
{% endblock %}
